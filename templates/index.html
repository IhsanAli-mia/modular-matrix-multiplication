<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Modular Matrix Multiplication</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/static/style.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
      <span class="navbar-brand fw-semibold">Modular Matrix Multiplier</span>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-12 col-xl-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Settings</h5>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Rows (A)</label>
                <input id="rowsA" type="number" min="1" class="form-control" value="2" />
              </div>
              <div class="col-6">
                <label class="form-label">Cols (A) / Rows (B)</label>
                <input id="colsA" type="number" min="1" class="form-control" value="2" />
              </div>
              <div class="col-6">
                <label class="form-label">Cols (B)</label>
                <input id="colsB" type="number" min="1" class="form-control" value="2" />
              </div>
              <div class="col-6">
                <label class="form-label">Modulus</label>
                <input id="modulus" type="number" min="1" class="form-control" value="2" />
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button id="btnBuild" class="btn btn-primary">Build Matrices</button>
              <button id="btnRandom" class="btn btn-outline-secondary" disabled>Random Fill</button>
            </div>

            <div class="form-text mt-2">
              Tip: Random fill uses values in [0, modulus - 1].
            </div>

            <div id="alert" class="alert alert-danger d-none mt-3" role="alert"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-8">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h5 class="card-title">Matrix A</h5>
            <div id="matrixA" class="matrix-grid"></div>
          </div>
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h5 class="card-title">Matrix B</h5>
            <div id="matrixB" class="matrix-grid"></div>
          </div>
        </div>

        <div class="d-flex gap-2 mb-3">
          <button id="btnMultiply" class="btn btn-success" disabled>Multiply (A Ã— B) mod m</button>
          <button id="btnClear" class="btn btn-outline-danger">Clear</button>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Result</h5>
            <div id="result" class="matrix-grid"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-4 text-center text-muted">
    <small>Built with Flask & Bootstrap</small>
  </footer>

  <script>
    const el = (id) => document.getElementById(id);

    function showAlert(msg) {
      const a = el('alert');
      a.textContent = msg;
      a.classList.remove('d-none');
    }
    function hideAlert() {
      el('alert').classList.add('d-none');
    }

    function buildTable(container, rows, cols) {
      container.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'table table-bordered align-middle mb-0';
      const tbody = document.createElement('tbody');
      for (let r = 0; r < rows; r++) {
        const tr = document.createElement('tr');
        for (let c = 0; c < cols; c++) {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.className = 'form-control form-control-sm';
          input.value = '0';
          input.dataset.r = r;
          input.dataset.c = c;
          td.appendChild(input);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function readMatrix(container, rows, cols) {
      const inputs = container.querySelectorAll('input[type="number"]');
      const M = Array.from({ length: rows }, () => Array(cols).fill(0));
      inputs.forEach(inp => {
        const r = parseInt(inp.dataset.r, 10);
        const c = parseInt(inp.dataset.c, 10);
        const val = inp.value.trim();
        if (val === '') throw new Error('All matrix cells must be filled.');
        const num = Number(val);
        if (!Number.isFinite(num) || !Number.isInteger(num)) {
          throw new Error('Matrix values must be integers.');
        }
        M[r][c] = num;
      });
      return M;
    }

    function randomFill(container, rows, cols, modulus) {
      const inputs = container.querySelectorAll('input[type="number"]');
      inputs.forEach(inp => {
        const v = Math.floor(Math.random() * modulus);
        inp.value = String(v);
      });
    }

    function renderResult(container, matrix) {
      container.innerHTML = '';
      const rows = matrix.length, cols = matrix[0]?.length || 0;
      const table = document.createElement('table');
      table.className = 'table table-striped table-bordered align-middle mb-0';
      const tbody = document.createElement('tbody');
      for (let r = 0; r < rows; r++) {
        const tr = document.createElement('tr');
        for (let c = 0; c < cols; c++) {
          const td = document.createElement('td');
          td.textContent = matrix[r][c];
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      container.appendChild(table);
    }

    function parseSettings() {
      const rowsA = parseInt(el('rowsA').value, 10);
      const colsA = parseInt(el('colsA').value, 10);
      const colsB = parseInt(el('colsB').value, 10);
      const modulus = parseInt(el('modulus').value, 10);

      if (![rowsA, colsA, colsB, modulus].every(Number.isInteger)) throw new Error('All settings must be integers.');
      if (rowsA <= 0 || colsA <= 0 || colsB <= 0) throw new Error('Dimensions must be positive.');
      if (modulus <= 0) throw new Error('Modulus must be a positive integer.');

      return { rowsA, colsA, colsB, modulus };
    }

    let built = false;

    el('btnBuild').addEventListener('click', () => {
      hideAlert();
      try {
        const { rowsA, colsA, colsB } = parseSettings();
        buildTable(el('matrixA'), rowsA, colsA);
        buildTable(el('matrixB'), colsA, colsB);
        built = true;
        el('btnRandom').disabled = false;
        el('btnMultiply').disabled = false;
        el('result').innerHTML = '';
      } catch (e) {
        showAlert(e.message);
      }
    });

    el('btnRandom').addEventListener('click', () => {
      hideAlert();
      if (!built) return;
      try {
        const { rowsA, colsA, colsB, modulus } = parseSettings();
        randomFill(el('matrixA'), rowsA, colsA, modulus);
        randomFill(el('matrixB'), colsA, colsB, modulus);
      } catch (e) {
        showAlert(e.message);
      }
    });

    el('btnMultiply').addEventListener('click', async () => {
      hideAlert();
      if (!built) return showAlert('Click "Build Matrices" first.');
      try {
        const { rowsA, colsA, colsB, modulus } = parseSettings();
        const A = readMatrix(el('matrixA'), rowsA, colsA);
        const B = readMatrix(el('matrixB'), colsA, colsB);

        const resp = await fetch('/multiply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ A, B, modulus })
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || 'Unknown error');
        renderResult(el('result'), data.result);
      } catch (e) {
        showAlert(e.message);
      }
    });

    el('btnClear').addEventListener('click', () => {
      hideAlert();
      el('matrixA').innerHTML = '';
      el('matrixB').innerHTML = '';
      el('result').innerHTML = '';
      el('btnRandom').disabled = true;
      el('btnMultiply').disabled = true;
      built = false;
    });
  </script>
</body>
</html>
